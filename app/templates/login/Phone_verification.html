{% extends "base.html" %}

{% block title %}電話番号認証{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename ='css/phone_vertification.css') }}">

<main class="main-content">
    <div class="auth-container">
        <h2 class="title">電話番号認証</h2>
        
        <p class="instruction-text">
            {{ masked_phone }}宛にSMSで認証コードを送信しました。<br>
            メッセージに記載された6桁の数字を確認し、入力してください。
        </p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    <li class="flash-{{ category }}">{{ message }}</li>
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('login.phone_auth') }}">
            <div class="code-input-group">
                {% for i in range(6) %}
                <input type="text" maxlength="1" name="code{{i}}" class="code-input">
                {% endfor %}
            </div>

            <button type="submit" class="btn btn-primary">認証する</button>
        </form>

        <form method="POST" action="{{ url_for('login.phone_auth_resend') }}">
            <button type="submit" class="btn btn-secondary">再送リクエスト</button>
        </form>
    </div>
</main>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const codeInputs = document.querySelectorAll('.code-input');
    const authForm = document.querySelector('form[action*="phone_auth"]');
    const authButton = authForm.querySelector('.btn-primary');

    // --- エラーメッセージ用の要素を作成（コード入力欄の下に） ---
    const codeGroup = document.querySelector('.code-input-group');
    let errorContainer = document.createElement('div');
    errorContainer.className = 'code-error';
    errorContainer.style.color = 'red';
    errorContainer.style.marginTop = '5px';
    codeGroup.insertAdjacentElement('afterend', errorContainer);

    // --- 1. 自動フォーカス移動と入力制御 ---
    codeInputs.forEach((input, index) => {
        // 数字以外の入力阻止
        input.addEventListener('keydown', (e) => {
            if (!((e.key >= '0' && e.key <= '9') ||
                  e.key === 'Backspace' || e.key === 'Delete' ||
                  e.key === 'Tab' || e.key.includes('Arrow'))) {
                e.preventDefault();
            }
        });

        // 入力イベント
        input.addEventListener('input', () => {
            input.value = input.value.replace(/\D/g, ''); // 数字以外削除
            if (input.value.length === 1 && index < codeInputs.length - 1) {
                codeInputs[index + 1].focus();
            }
            // 入力中はエラー非表示
            errorContainer.textContent = '';
        });

        // Backspaceで前のフィールドに移動
        input.addEventListener('keyup', (e) => {
            if (e.key === 'Backspace' && input.value.length === 0 && index > 0) {
                codeInputs[index - 1].focus();
            }
        });
    });

    // --- 2. 送信時バリデーション ---
    authForm.addEventListener('submit', (e) => {
        let completeCode = '';
        let firstEmptyInput = null;
        let allDigits = true;

        codeInputs.forEach(input => {
            completeCode += input.value;
            if (input.value.length === 0 && !firstEmptyInput) {
                firstEmptyInput = input;
            }
            if (!/^\d$/.test(input.value)) {
                allDigits = false;
            }
        });

        if (completeCode.length !== 6 || !allDigits) {
            e.preventDefault();
            errorContainer.textContent = '未入力項目があります。6桁すべての数字を入力してください。';
            if (firstEmptyInput) firstEmptyInput.focus();
        }
    });
});
</script>
{% endblock %}

