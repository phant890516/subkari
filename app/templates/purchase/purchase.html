{% extends "base.html" %}
{% block title %}
    購入の確認
{% endblock %}

{% block content %}
    <link href="{{url_for('static',filename='css/purchase.css')}}" rel="stylesheet">
    <div class="container">
        <h1>購入の確認</h1>

        <div class="content-wrapper">
            <div class="left-column">
                <!-- 商品情報 -->
                <div class="section">
                    <div class="product-info">
                        <div class="product-image">
                            {% if images %}
                            <img src="{{url_for('static', filename='img/productImg/' + images[0].img)}}" alt="{{product.name }}"></div>
                            {% else %}
                            <img src="{{url_for('static', filename='img/productImg/default.png')}}" alt="デフォルト画像"></div>
                            {% endif %}
                            <div class="product-details">
                                <div class="product-name">{{ product.product_name }}</div>
                                <div class="product-price">¥{{ product.purchasePrice }}</div>
                            </div>
                    </div>
                </div>

                <!-- 支払い方法 -->
                <!-- <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">支払い方法</h2>
                        <a href="#" class="change-btn" onclick="openPaymentModal(event)">変更する</a>
                    </div>
                    <div class="payment-info">
                        クレジットカード決済
                        <div class="masked-card" id="selectedCard">************1234 01/01</div>
                    </div>
                </div> -->

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">支払い方法</h2>
                        <a href="#" class="change-btn" onclick="openPaymentModal(event)">変更する</a>
                    </div>
                    <div class="payment-info" id="selectedPaymentInfo">
                        {# card_info にデータがない場合のみ、初期メッセージを表示 #}
                        {% if not card_info or card_info|length == 0 %}
                            <p>支払い方法が登録されていません。「変更する」ボタンから登録してください。</p>
                        {% endif %}
                    </div>
                </div>

                <!-- 配送先 -->
                 <!-- <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">配送先</h2>
                        <a href="#" class="change-btn" onclick="openAddressModal(event)">変更する</a>
                    </div>
                    <div class="shipping-info" id="selectedAddress">
                        {# address_list にデータが存在するかチェックします #}
                        {% if address_list %}
                            {# address_list の最初の要素 (インデックス 0) を addr という変数に格納します #}
                            {% set addr = address_list[0] %}
                            
                            
                            {# 住所データを出力します。addr は辞書なので . (ドット) でキーにアクセスします #}
                            〒{{ addr.zip }}<br>
                            {{ addr.pref }} {{ addr.address1 }} {{ addr.address2 }}<br>
                            {% if addr.address3 %}
                                {{ addr.address3 }}
                            {% endif %}
                        {% else %}
                            {# 住所データがない場合の表示 #}
                            <p>配送先の住所が登録されていません。「変更する」ボタンから登録してください。</p>
                        {% endif %}
                    </div>

                </div> -->


                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">配送先</h2>
                        <a href="#" class="change-btn" onclick="openAddressModal(event)">変更する</a>
                    </div>
                
                    <div class="shipping-info" id="selectedAddress">
                    
                    {# 住所データがある場合の初期表示ロジックは全て削除します #}
                    
                    {% if not address_list or address_list|length == 0 %}
                        {# 住所データがない場合の表示のみ残します #}
                        <p>配送先の住所が登録されていません。「変更する」ボタンから登録してください。</p>
                    {% endif %}
                    
                    <!-- 住所データがある場合、初期表示はJavaScript (DOMContentLoaded) に任せます。
                    このブロックが空の場合は、JavaScriptが実行されるまでの間は何も表示されません。
                    JavaScriptは address_list[0] の内容でこの div の中身を上書きします。 -->
                    </div>
                </div>



                <!-- 置き配の指定 -->
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">置き配の指定</h2>
                        <a href="#" class="change-btn" onclick="openDeliveryLocationModal(event)">変更する</a>
                    </div>
                    <div class="delivery-info" id="selectedDeliveryLocation">
                        玄関前
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="summary-box">
                    <div class="summary-row">
                        <span class="summary-label">商品代金</span>
                        <span class="summary-value">¥{{ product.purchasePrice }}</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">お支払い方法</span>
                        <span class="summary-value" id="payment-summary-value">クレジットカード</span>
                    </div>
                </div>

                <div class="terms-notice">
                    <a href="#">利用規約</a>および<a href="#">プライバシーポリシー</a>に同意の上、ご購入ください。
                </div>
                



                <form method="POST" id="purchaseForm" action="{{ url_for('products.transaction_complete') }}">
                    <input type="hidden" id="hidden_product_id" name="product_id" value="{{ product.id }}">
                    <input type="hidden" id="hidden_payment_method" name="payment_method" value="initial_payment_value">
                    <input type="hidden" id="hidden_creditcards_id" name="creditcard_id" value="initial_creditcards_id_value">
                    <input type="hidden" id="hidden_address_index" name="address_index" value="initial_address_index_value">
                    <input type="hidden" id="hidden_delivery_location" name="delivery_location" value="玄関前">
                    <input type="hidden" id="hidden_situation" name="situation" value="購入">
                    <button class="confirm-btn" onclick="confirmPurchase()">購入を確定する</button>
                </form>
            </div>
        </div>
    </div>

    <!-- カード登録ページオーバーレイ -->
    <div class="card-register-overlay" id="cardRegisterPage">
        <div class="card-register-header">
            <div class="logo">SUBKARI</div>
            <a class="back-link" onclick="closeCardRegister()">← 戻る</a>
        </div>
        <div class="card-register-container-inner">
            <div class="card-register-content">
                <h2 class="card-register-title">クレジットカードの登録</h2>

                <div class="card-brands-section">
                    <div class="card-brands-label">利用可能なクレジットカード</div>
                    <div class="card-logos">
                        <span class="visa-logo">VISA</span>
                        <div class="mastercard-logo"></div>
                        <span class="jcb-logo">JCB</span>
                        <span class="amex-logo">AMEX</span>
                    </div>
                </div>

                <form onsubmit="registerNewCard(event)">
                    <div class="form-group">
                        <label class="form-label">カード番号</label>
                        <input type="text" class="form-input" placeholder="0000 0000 0000 0000" maxlength="19" id="newCardNumber">
                    </div>

                    <div class="form-group">
                        <label class="form-label">有効期限</label>
                        <input type="text" class="form-input" placeholder="MM/YY" maxlength="5" id="newCardExpiry">
                    </div>

                    <div class="form-group">
                        <label class="form-label">セキュリティコード</label>
                        <input type="text" class="form-input" placeholder="3桁または4桁の番号" maxlength="4" id="newSecurityCode">
                        <div class="security-help" onclick="openSecurityHelp()">
                            <span>セキュリティコードとは</span>
                            <div class="help-icon">?</div>
                        </div>
                    </div>

                    <button type="submit" class="register-btn">登録する</button>
                </form>
            </div>
        </div>
    </div>

   

   





   



    <!-- 支払い方法モーダル -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">お支払い方法</h3>
                <a href="#" class="edit-link" onclick="editPaymentMethods(event)">編集する</a>
            </div>
            <div class="modal-body">
                {% for card in card_info %}
                {% set index = loop.index0 %}
                <div class="payment-option" onclick="selectPayment('card{{ card.id }}')">
                    <div class="radio-btn {% if loop.first %}selected{% endif %}" id="radio-card{{ card.id }}"></div>
                    <div class="payment-details">
                        <div class="card-number">
                            {## カード番号の下4桁と有効期限を表示（末尾4桁以外を * でマスク） ##}
                            {{ "************" ~ card.number[-4:] }} ({{ card.expiry }})
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div class="add-card-link" onclick="goToCardRegister()">
                    <div class="add-icon">+</div>
                    <span>新しいクレジットカードを登録する</span>
                </div>
                <div class="payment-method-item" onclick="selectPayment('conveni')">
                    <div class="radio-btn {% if not card_info %}selected{% endif %}" id="radio-conveni"></div>
                    <div class="payment-method-name">コンビニ支払い</div>
                </div>
                <div class="payment-method-item" onclick="selectPayment('paypay')">
                    <div class="radio-btn" id="radio-paypay"></div>
                    <div class="payment-method-name">PayPay</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="update-btn" onclick="closePaymentModal()">更新する</button>
            </div>
        </div>
    </div>

    <!-- 支払い方法編集モーダル -->
    <div class="modal" id="paymentEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">お支払い方法</h3>
                <a href="#" class="edit-link" onclick="completePaymentEdit(event)">完了する</a>
            </div>
            <div class="modal-body">
                <!-- クレジットカード1 -->
                <div class="payment-option" onclick="selectPayment('card1')">
                    <div class="radio-btn selected" id="radio-edit-card1"></div>
                    <div class="payment-details">
                        <div class="card-number">************1234 01/01</div>
                    </div>
                    <button class="delete-btn" onclick="confirmDeleteCard(event, 'card1')">削除する</button>
                </div>

                <!-- クレジットカード2 -->
                <div class="payment-option" onclick="selectPayment('card2')">
                    <div class="radio-btn" id="radio-edit-card2"></div>
                    <div class="payment-details">
                        <div class="card-number">************1234 02/02</div>
                    </div>
                    <button class="delete-btn" onclick="confirmDeleteCard(event, 'card2')">削除する</button>
                </div>

                <!-- クレジットカード3 -->
                <div class="payment-option" onclick="selectPayment('card3')">
                    <div class="radio-btn" id="radio-edit-card3"></div>
                    <div class="payment-details">
                        <div class="card-number">************1234 03/03</div>
                    </div>
                    <button class="delete-btn" onclick="confirmDeleteCard(event, 'card3')">削除する</button>
                </div>

                <!-- 新しいクレジットカード追加 -->
                <div class="add-card-link" onclick="goToCardRegister()">
                    <div class="add-icon">+</div>
                    <span>新しいクレジットカードを登録する</span>
                </div>

                <!-- コンビニ支払い -->
                <div class="payment-method-item" onclick="selectPayment('conveni')">
                    <div class="radio-btn" id="radio-edit-conveni"></div>
                    <div class="payment-method-name">コンビニ支払い</div>
                </div>

                <!-- PayPay -->
                <div class="payment-method-item" onclick="selectPayment('paypay')">
                    <div class="radio-btn" id="radio-edit-paypay"></div>
                    <div class="payment-method-name">PayPay</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="update-btn" onclick="">更新する</button>
            </div>
        </div>
    </div>

    <!-- 削除確認モーダル -->
    <div class="modal" id="deleteConfirmModal">
        <div class="confirm-modal">
            <p class="confirm-modal-text">この項目を削除しますか？</p>
            <div class="confirm-modal-buttons">
                <button class="cancel-btn" onclick="closeDeleteConfirm()">キャンセル</button>
                <button class="delete-confirm-btn" onclick="executeDelete()">削除する</button>
            </div>
        </div>
    </div>

    <!-- 置き配指定モーダル -->
    <div class="modal" id="deliveryLocationModal">
        <div class="modal-content">
            <div class="modal-header" style="position: relative;">
                <h3 class="modal-title">置き配の指定</h3>
                <button class="close-btn" onclick="closeDeliveryLocationModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="delivery-option" onclick="selectDeliveryLocation('玄関前')">
                    <div class="radio-btn selected" id="radio-door"></div>
                    <div class="delivery-option-text">玄関前</div>
                </div>
                <div class="delivery-option" onclick="selectDeliveryLocation('宅配ボックス')">
                    <div class="radio-btn" id="radio-box"></div>
                    <div class="delivery-option-text">宅配ボックス</div>
                </div>
                <div class="delivery-option" onclick="selectDeliveryLocation('ガスメーターボックス')">
                    <div class="radio-btn" id="radio-gas"></div>
                    <div class="delivery-option-text">ガスメーターボックス</div>
                </div>
                <div class="delivery-option" onclick="selectDeliveryLocation('自転車のカゴ')">
                    <div class="radio-btn" id="radio-bicycle"></div>
                    <div class="delivery-option-text">自転車のカゴ</div>
                </div>
                <div class="delivery-option" onclick="selectDeliveryLocation('車庫')">
                    <div class="radio-btn" id="radio-garage"></div>
                    <div class="delivery-option-text">車庫</div>
                </div>
                <div class="delivery-option" onclick="selectDeliveryLocation('建物内受付/管理人')">
                    <div class="radio-btn" id="radio-reception"></div>
                    <div class="delivery-option-text">建物内受付/管理人</div>
                </div>
                <div class="delivery-option" onclick="selectDeliveryLocation('選択しない')">
                    <div class="radio-btn" id="radio-none"></div>
                    <div class="delivery-option-text">選択しない</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="update-btn" onclick="updateDeliveryLocation()">更新する</button>
            </div>
        </div>
    </div>

    <!-- 配送先住所一覧モーダル -->
    <div class="modal" id="addressModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">住所一覧</h3>
                <a href="#" class="edit-link" onclick="editAddresses(event)">編集する</a>
            </div>
            <div class="modal-body">
                <!-- 住所1 -->
                 <!-- {% for addr in address_list %}
                <div class="address-option" onclick="selectAddress('address1')">
                    <div class="radio-btn selected" id="radio-address1"></div>
                    <div class="address-details">
                        <div class="address-postal">〒{{ addr.zip }}</div>
                        <div class="address-name">{{ addr.pref }} {{ addr.address1 }} {{ addr.address2 }} {% if addr.address3 %}
                    {{ addr.address3 }}
                {% endif %}</div>
                    </div>
                </div>
                {% endfor %} -->



                {% for addr in address_list %}
                <div class="address-option" onclick="selectAddress('address-{{ addr.id }}')">
                    <div class="radio-btn {% if loop.first %}selected{% endif %}" id="radio-address-{{ addr.id }}"></div>
                    <div class="address-details">
                        <div class="address-postal">〒{{ addr.zip }}</div>
                        <div class="address-name">
                            {{ addr.pref }} {{ addr.address1 }} {{ addr.address2 }} 
                            {% if addr.address3 %}
                                {{ addr.address3 }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- 住所2
                <div class="address-option" onclick="selectAddress('address2')">
                    <div class="radio-btn" id="radio-address2"></div>
                    <div class="address-details">
                        <div class="address-name">HAL 東京（ハル トウキョウ）</div>
                        <div class="address-postal">〒160-0023</div>
                        <div class="address-full">東京都新宿区西新宿1丁目7−3</div>
                    </div>
                </div>

                 住所3 -->
                <!-- <div class="address-option" onclick="selectAddress('address3')">
                    <div class="radio-btn" id="radio-address3"></div>
                    <div class="address-details">
                        <div class="address-name">HAL 名古屋（ハル ナゴヤ）</div>
                        <div class="address-postal">〒450-0002</div>
                        <div class="address-full">愛知県名古屋市中村区名駅4丁目27−1</div>
                    </div>
                </div> -->

                <!-- 新しい住所追加 -->
                <div class="add-card-link" onclick="addNewAddress()">
                    <div class="add-icon">+</div>
                    <span>新しい住所を登録する</span>
                </div>

                <!-- 警告文 -->
                <div class="warning-notice">
                    <span class="warning-icon">⚠</span>
                    <span>「新しい住所を登録」に郵便局/コンビニの住所を設定されても、商品を受取ることはできません</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="update-btn" onclick="closeAddressModal()">更新する</button>
            </div>
        </div>
    </div>

    <!-- 配送先住所編集モーダル -->
    <div class="modal" id="addressEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">住所一覧</h3>
                <a href="#" class="edit-link" onclick="completeAddressEdit(event)">完了する</a>
            </div>
            <div class="modal-body">
                <!-- 住所1 -->
                <div class="address-option" onclick="selectAddress('address1')">
                    <div class="radio-btn selected" id="radio-edit-address1"></div>
                    <div class="address-details">
                        <div class="address-name">HAL 大阪（ハル オオサカ）</div>
                        <div class="address-postal">〒530-0001</div>
                        <div class="address-full">大阪府 大阪市 北区 梅田3丁目3−1</div>
                    </div>
                    <div class="address-actions">
                        <button class="address-delete-btn" onclick="confirmDeleteAddress(event, 'address1')">削除する</button>
                    </div>
                </div>

                <!-- 住所2 -->
                <div class="address-option" onclick="selectAddress(6)">
                    <div class="radio-btn" id="radio-edit-address2"></div>
                    <div class="address-details">
                        <div class="address-name">HAL 東京（ハル トウキョウ）</div>
                        <div class="address-postal">〒160-0023</div>
                        <div class="address-full">東京都新宿区西新宿1丁目7−3</div>
                    </div>
                    <div class="address-actions">
                        <button class="address-delete-btn" onclick="confirmDeleteAddress(event, 'address2')">削除する</button>
                    </div>
                </div>

                <!-- 住所3 -->
                <div class="address-option" onclick="selectAddress('address3')">
                    <div class="radio-btn" id="radio-edit-address3"></div>
                    <div class="address-details">
                        <div class="address-name">HAL 名古屋（ハル ナゴヤ）</div>
                        <div class="address-postal">〒450-0002</div>
                        <div class="address-full">愛知県名古屋市中村区名駅4丁目27−1</div>
                    </div>
                    <div class="address-actions">
                        <button class="address-delete-btn" onclick="confirmDeleteAddress(event, 'address3')">削除する</button>
                    </div>
                </div>

                <!-- 新しい住所追加 -->
                <div class="add-card-link" onclick="addNewAddress()">
                    <div class="add-icon">+</div>
                    <span>新しい住所を登録する</span>
                </div>

                <!-- 警告文 -->
                <div class="warning-notice">
                    <span class="warning-icon">⚠</span>
                    <span>「新しい住所を登録」に郵便局/コンビニの住所を設定されても、商品を受取ることはできません</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="update-btn" onclick="closeAddressModal()">更新する</button>
            </div>
        </div>
    </div>

    <!-- セキュリティコード説明モーダル -->
    <div class="modal" id="securityHelpModal">
        <div class="security-modal-content">
            <button class="close-btn" onclick="closeSecurityHelp()" style="position: absolute;">×</button>
            <h3 class="security-modal-title">セキュリティコードとは</h3>
            <p class="security-modal-text">
                カードの前面もしくは背面に記載されている、3桁または4桁の番号をご確認ください
            </p>
            <div class="security-card-images">
                <div class="security-card-image">
                    <div class="card-back"></div>
                    <span class="security-code-label" style="bottom: 20px; right: 20px;">123</span>
                </div>
                <div class="security-card-image amex">
                    <span class="security-code-label" style="top: 50px; right: 20px;">1234</span>
                    <span style="position: absolute; top: 20px; left: 20px; font-size: 10px; font-weight: bold; color: #fff;">AMERICAN EXPRESS</span>
                    <span style="position: absolute; bottom: 20px; left: 20px; font-size: 9px; color: #fff;">3333 123456 9000</span>
                </div>
            </div>
        </div>
    </div>

    <script>

    // 住所情報と同様に、支払い方法のデータもJSに渡す
    const addressDataList = {{ address_list | tojson | default('[]') | safe }}; 
    const cardInfoList = {{ card_info | tojson | default('[]') | safe }}; // ★ cardInfoListに変更

    // let selectedAddressIndex = 0; 
 
     // 新しい支払い方法用のインデックス変数
    // let selectedCardIndex = 0; // ★ selectedCardIndex に変更


    //選択された住所・カードのインデックスを保持する変数を追加
    let selectedAddressId = null; 
    let selectedDeliveryLocation = '玄関前';
    let selectedPaymentMethod = 'conveni';
    // ページロード時の処理
    document.addEventListener('DOMContentLoaded', () => {
        // 住所の初期表示
        if (addressDataList.length > 0) {
            // 最初の住所のIDを取得して表示
            const firstAddressId = addressDataList[0].id;
            selectedAddressId = firstAddressId; // グローバル変数に保存
            updateShippingInfo(`address-${firstAddressId}`);
        }
        
        // 【支払い方法の初期表示】
        if (cardInfoList.length > 0) {
         // カード情報がある場合、最初のカードを初期選択として表示
            const firstCardId = cardInfoList[0].id;
            selectedPaymentMethod = `card${firstCardId}`;   // グローバル変数に保存
            updatePaymentInfo(`card${firstCardId}`);
        } else {
         // カード情報がない場合、初期選択 ('conveni') を表示
            updatePaymentInfo(selectedPaymentMethod);
        }
        
        // 初期値をフォームにセット
        updateHiddenFormFields();
    });





</script>
    <script src="{{url_for('static',filename='js/purchase.js')}}"></script>

{% endblock %}